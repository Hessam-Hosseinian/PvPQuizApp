 # مستندات شمای پایگاه داده PvPQuizApp

این مستند به تفصیل ساختار پایگاه داده اپلیکیشن PvPQuizApp را شرح می‌دهد. هدف از این مستند، ارائه یک نمای کلی از جداول، روابط بین آن‌ها و منطق پشت طراحی است.

---

## فهرست جداول

1.  [جداول اصلی کاربر و پروفایل](#1-جداول-اصلی-کاربر-و-پروفایل)
    *   `users`
2.  [دسته‌بندی‌ها](#2-دسته‌بندی‌ها)
    *   `categories`
3.  [تگ‌ها و سوالات](#3-تگ‌ها-برای-سوالات)
    *   `tags`
    *   `question_tags`
4.  [جداول سوالات و گزینه‌ها](#4-جداول-سوالات-و-گزینه‌ها)
    *   `questions`
    *   `question_choices`
5.  [انواع بازی](#5-انواع-بازی)
    *   `game_types`
6.  [جداول بازی‌ها و شرکت‌کنندگان](#6-جداول-بازی‌ها-و-شرکت‌کنندگان)
    *   `games`
    *   `game_participants`
7.  [صف انتظار بازی](#7-صف-انتظار-بازی)
    *   `match_queue`
8.  [دعوت‌نامه‌های بازی](#8-دعوت‌نامه‌های-بازی)
    *   `game_invitations`
9.  [روندهای بازی](#9-روندهای-بازی)
    *   `game_rounds`
10. [سوالات هر راند بازی](#10-سوالات-هر-راند-بازی)
    *   `game_round_questions`
11. [پاسخ‌های هر راند](#11-پاسخ‌های-هر-راند)
    *   `round_answers`
12. [آمار کلی و دسته‌بندی‌شده کاربران](#12-آمار-کاربران)
    *   `user_stats`
    *   `user_category_stats`
13. [جدول امتیازات (Leaderboards)](#13-جدول-امتیازات)
    *   `leaderboards`
14. [چت‌روم‌ها و پیام‌ها](#14-چت‌روم‌ها-و-پیام‌ها)
    *   `chat_rooms`
    *   `chat_room_members`
    *   `chat_messages`
15. [اعلان‌ها (Notifications)](#15-اعلان‌ها)
    *   `notification_types`
    *   `notifications`
16. [ ایندکس‌های بهینه‌سازی شده](#16-ایندکس‌های-بهینه‌سازی-شده)
17. [نمای Materialized برای بازیکنان برتر](#17-نمای-materialized-برای-بازیکنان-برتر)
    *   `mv_top_players`
18. [توابع و تریگرها](#18-توابع-و-تریگرها)

---

## 1. جداول اصلی کاربر و پروفایل

### `users`

این جدول اطلاعات اصلی کاربران را ذخیره می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی، شناسه‌ی یکتای کاربر. |
| `username` | `VARCHAR(50)` | نام کاربری منحصر به فرد. |
| `email` | `VARCHAR(120)` | ایمیل منحصر به فرد کاربر. فرمت ایمیل بررسی می‌شود. |
| `password_hash` | `VARCHAR(255)` | هش رمز عبور کاربر برای امنیت. |
| `avatar` | `VARCHAR(255)` | مسیر فایل آواتار کاربر. (اختیاری) |
| `created_at` | `TIMESTAMP` | زمان ایجاد حساب کاربری. |
| `last_login` | `TIMESTAMP` | زمان آخرین ورود کاربر. (اختیاری) |
| `is_active` | `BOOLEAN` | وضعیت فعال بودن حساب کاربری. |
| `role` | `VARCHAR(20)` | نقش کاربر (user, admin, moderator). |
| `current_level` | `INTEGER` | سطح فعلی کاربر در بازی. |
| `total_xp` | `BIGINT` | مجموع امتیاز تجربه (XP) کاربر. |

---

## 2. دسته‌بندی‌ها

### `categories`

این جدول دسته‌بندی‌های مختلف سوالات را نگهداری می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `SERIAL` | کلید اصلی، شناسه‌ی یکتای دسته‌بندی. |
| `name` | `VARCHAR(100)` | نام منحصر به فرد دسته‌بندی. |
| `description` | `TEXT` | توضیحات مربوط به دسته‌بندی. (اختیاری) |
| `created_at` | `TIMESTAMP` | زمان ایجاد دسته‌بندی. |

---



## 4. جداول سوالات و گزینه‌ها

### `questions`

این جدول، سوالات اصلی آزمون‌ها را ذخیره می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی، شناسه‌ی یکتای سوال. |
| `text` | `TEXT` | متن کامل سوال. |
| `category_id` | `INTEGER` | کلید خارجی به جدول `categories`. نشان‌دهنده دسته‌بندی سوال. |
| `difficulty` | `VARCHAR(20)` | درجه سختی سوال (easy, medium, hard). |
| `is_verified` | `BOOLEAN` | آیا سوال توسط ادمین تأیید شده است یا خیر. |
| `created_at` | `TIMESTAMP` | زمان ایجاد سوال. |
| `created_by` | `BIGINT` | کلید خارجی به جدول `users`، نشان‌دهنده کاربری که سوال را ایجاد کرده. |

### `question_choices`

این جدول گزینه‌های مربوط به هر سوال را نگهداری می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی، شناسه‌ی یکتای گزینه. |
| `question_id` | `BIGINT` | کلید خارجی به جدول `questions`. |
| `choice_text` | `TEXT` | متن گزینه. |
| `is_correct` | `BOOLEAN` | مشخص می‌کند که آیا این گزینه پاسخ صحیح است یا خیر. |
| `position` | `CHAR(1)` | موقعیت گزینه (A, B, C, D). |

---

## 5. انواع بازی

### `game_types`

این جدول انواع مختلف بازی‌های موجود را تعریف می‌کند (مثلا دوئل، گروهی).

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `SERIAL` | کلید اصلی، شناسه‌ی یکتای نوع بازی. |
| `name` | `VARCHAR(50)` | نام منحصر به فرد نوع بازی. |
| `description` | `TEXT` | توضیحات نوع بازی. (اختیاری) |
| `total_rounds` | `SMALLINT` | تعداد کل راندهای بازی. |

---

## 6. جداول بازی‌ها و شرکت‌کنندگان

### `games`

هر رکورد در این جدول یک بازی منحصر به فرد را نشان می‌دهد.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی، شناسه‌ی یکتای بازی. |
| `game_type_id` | `INTEGER` | کلید خارجی به `game_types`. |
| `status` | `VARCHAR(20)` | وضعیت بازی (pending, active, completed, cancelled). |
| `start_time` | `TIMESTAMP` | زمان شروع بازی. |
| `end_time` | `TIMESTAMP` | زمان پایان بازی. |
| `winner_id` | `BIGINT` | کلید خارجی به `users`، شناسه‌ی کاربر برنده. |
| `created_at` | `TIMESTAMP` | زمان ایجاد رکورد بازی. |

### `game_participants`

جدول واسط برای نگهداری شرکت‌کنندگان هر بازی.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `game_id` | `BIGINT` | کلید خارجی به `games`. |
| `user_id` | `BIGINT` | کلید خارجی به `users`. |
| `join_time` | `TIMESTAMP` | زمان پیوستن کاربر به بازی. |
| `score` | `INTEGER` | امتیاز کاربر در این بازی. |
| `status` | `VARCHAR(20)` | وضعیت بازیکن در بازی (active, disconnected, finished). |

---

## 7. صف انتظار بازی

### `match_queue`

کاربرانی که منتظر یافتن حریف برای شروع بازی هستند در این جدول قرار می‌گیرند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی. |
| `user_id` | `BIGINT` | کلید خارجی به `users`. |
| `game_type_id` | `INTEGER` | کلید خارجی به `game_types`. |
| `enqueued_at` | `TIMESTAMP` | زمان ورود کاربر به صف انتظار. |

---



## 9. روندهای بازی

### `game_rounds`

هر بازی شامل چندین راند است. این جدول اطلاعات هر راند را ذخیره می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی. |
| `game_id` | `BIGINT` | کلید خارجی به `games`. |
| `round_number` | `SMALLINT` | شماره راند در بازی. |
| `category_id` | `INTEGER` | کلید خارجی به `categories`، دسته‌بندی انتخاب شده برای این راند. |
| `category_picker_id` | `BIGINT` | کلید خارجی به `users`، کاربری که دسته‌بندی را انتخاب کرده. |
| `start_time` | `TIMESTAMP` | زمان شروع راند. |
| `end_time` | `TIMESTAMP` | زمان پایان راند. |
| `status` | `VARCHAR(20)` | وضعیت راند (pending, active, completed). |
| `time_limit_seconds` | `INTEGER` | محدودیت زمانی برای پاسخ به سوالات راند. |
| `points_possible` | `INTEGER` | حداکثر امتیاز ممکن در این راند. |

---

## 10. سوالات هر راند بازی

### `game_round_questions`

این جدول مشخص می‌کند که کدام سوالات در کدام راند از کدام بازی پرسیده شده‌اند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی. |
| `game_round_id` | `BIGINT` | کلید خارجی به `game_rounds`. |
| `question_id` | `BIGINT` | کلید خارجی به `questions`. |

---

## 11. پاسخ‌های هر راند

### `round_answers`

این جدول پاسخ‌های کاربران به سوالات هر راند را ثبت می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی. |
| `game_round_question_id` | `BIGINT` | کلید خارجی به `game_round_questions`. |
| `user_id` | `BIGINT` | کلید خارجی به `users`، کاربری که پاسخ داده. |
| `choice_id` | `BIGINT` | کلید خارجی به `question_choices`، گزینه انتخاب شده توسط کاربر. |
| `answer_time` | `TIMESTAMP` | زمان ثبت پاسخ. |
| `response_time_ms` | `INTEGER` | زمان پاسخگویی کاربر به میلی‌ثانیه. |
| `is_correct` | `BOOLEAN` | آیا پاسخ صحیح بوده است یا خیر. |
| `points_earned` | `INTEGER` | امتیاز کسب شده برای این پاسخ. |

---

## 12. آمار کاربران

### `user_stats`

آمار کلی عملکرد هر کاربر در تمام بازی‌ها.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `user_id` | `BIGINT` | کلید اصلی و خارجی به `users`. |
| `games_played` | `INTEGER` | تعداد کل بازی‌های انجام شده. |
| `games_won` | `INTEGER` | تعداد کل بازی‌های برده. |
| `total_points` | `BIGINT` | مجموع کل امتیازات کسب شده. |
| `correct_answers` | `INTEGER` | تعداد کل پاسخ‌های صحیح. |
| `total_answers` | `INTEGER` | تعداد کل پاسخ‌های داده شده. |
| `average_response_time_ms`| `INTEGER` | میانگین زمان پاسخگویی. |
| `highest_score` | `INTEGER` | بالاترین امتیاز کسب شده در یک بازی. |
| `current_streak`| `INTEGER` | تعداد بردهای متوالی فعلی. |
| `best_streak` | `INTEGER` | بهترین رکورد بردهای متوالی. |
| `last_played_at`| `TIMESTAMP` | زمان آخرین بازی. |
| `stats_updated_at`| `TIMESTAMP` | زمان آخرین بروزرسانی آمار. |

### `user_category_stats`

آمار عملکرد کاربر در هر دسته‌بندی به صورت جداگانه.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `user_id` | `BIGINT` | کلید خارجی به `users`. |
| `category_id` | `INTEGER` | کلید خارجی به `categories`. |
| `games_played`| `INTEGER` | تعداد بازی‌های انجام شده در این دسته‌بندی. |
| `correct_answers`| `INTEGER` | تعداد پاسخ‌های صحیح در این دسته‌بندی. |
| `total_answers`| `INTEGER` | تعداد کل پاسخ‌ها در این دسته‌بندی. |
| `total_points`| `BIGINT` | مجموع امتیازات در این دسته‌بندی. |

---

## 13. جدول امتیازات

### `leaderboards`

این جدول رتبه‌بندی کاربران را در بازه‌های زمانی مختلف (روزانه، هفتگی، ماهانه، کلی) ذخیره می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `SERIAL` | کلید اصلی. |
| `user_id` | `BIGINT` | کلید خارجی به `users`. |
| `scope` | `VARCHAR(20)` | بازه زمانی (`daily`, `weekly`, `monthly`, `alltime`). |
| `category_id` | `INTEGER` | کلید خارجی به `categories` (برای لیدربوردهای دسته‌بندی خاص). (اختیاری) |
| `rank` | `INTEGER` | رتبه کاربر. |
| `score` | `BIGINT` | امتیاز کاربر. |
| `generated_at`| `TIMESTAMP` | زمان تولید این رکورد از لیدربورد. |

---

## 14. چت‌روم‌ها و پیام‌ها

### `chat_rooms`

این جدول اتاق‌های گفتگو را مدیریت می‌کند که می‌توانند خصوصی، عمومی یا مربوط به یک بازی خاص باشند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی. |
| `name` | `VARCHAR(100)`| نام اتاق گفتگو. (اختیاری) |
| `type` | `VARCHAR(20)` | نوع اتاق (`private`, `game`, `public`). |
| `created_at`| `TIMESTAMP` | زمان ایجاد اتاق. |
| `game_id` | `BIGINT` | کلید خارجی به `games` (اگر اتاق مربوط به بازی باشد). (اختیاری) |

### `chat_room_members`

جدول واسط برای نگهداری اعضای هر اتاق گفتگو.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `room_id` | `BIGINT` | کلید خارجی به `chat_rooms`. |
| `user_id` | `BIGINT` | کلید خارجی به `users`. |
| `joined_at` | `TIMESTAMP` | زمان پیوستن کاربر به اتاق. |

### `chat_messages`

این جدول تمام پیام‌های ارسال شده در سیستم چت را ذخیره می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی. |
| `room_id` | `BIGINT` | کلید خارجی به `chat_rooms` (برای پیام‌های گروهی). |
| `sender_id` | `BIGINT` | کلید خارجی به `users`، فرستنده پیام. |
| `recipient_id`| `BIGINT` | کلید خارجی به `users`، گیرنده پیام (برای پیام‌های خصوصی). |
| `reply_to_id` | `BIGINT` | کلید خارجی به همین جدول برای پاسخ به یک پیام دیگر. |
| `message` | `TEXT` | متن پیام. |
| `is_edited` | `BOOLEAN` | آیا پیام ویرایش شده است. |
| `is_deleted` | `BOOLEAN` | آیا پیام حذف شده است. |
| `is_read` | `BOOLEAN` | آیا پیام توسط گیرنده خوانده شده است. |
| `sent_at` | `TIMESTAMP` | زمان ارسال پیام. |

---

## 15. اعلان‌ها (Notifications)

### `notification_types`

این جدول انواع مختلف اعلان‌ها و قالب پیام آن‌ها را تعریف می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `SERIAL` | کلید اصلی. |
| `name` | `VARCHAR(50)`| نام منحصر به فرد نوع اعلان. |
| `template` | `TEXT` | قالب متنی اعلان. |
| `importance`| `VARCHAR(20)`| درجه اهمیت (`low`, `normal`, `high`). |

### `notifications`

این جدول اعلان‌های ارسال شده برای هر کاربر را نگهداری می‌کند.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `id` | `BIGSERIAL` | کلید اصلی. |
| `type_id` | `INTEGER` | کلید خارجی به `notification_types`. |
| `user_id` | `BIGINT` | کلید خارجی به `users`، کاربری که اعلان را دریافت می‌کند. |
| `data` | `TEXT` | داده‌های جایگزین برای قالب اعلان (در فرمت JSON). |
| `is_read` | `BOOLEAN` | آیا اعلان خوانده شده است. |
| `created_at`| `TIMESTAMP` | زمان ایجاد اعلان. |
| `related_game_id` | `BIGINT` | کلید خارجی به `games` (اگر اعلان مربوط به بازی باشد). |

---

## 16. ایندکس‌های بهینه‌سازی شده

برای بهبود سرعت کوئری‌ها، ایندکس‌های مختلفی بر روی ستون‌های پرکاربرد تعریف شده‌اند. ایندکس‌ها به خصوص در جداول `users`, `questions`, `games`, `chat_messages` و `notifications` که حجم داده بالایی دارند و زیاد مورد جستجو قرار می‌گیرند، حیاتی هستند.

---

## 17. نمای Materialized برای بازیکنان برتر

### `mv_top_players`

این یک `Materialized View` است که لیستی از بازیکنان برتر را بر اساس آمار کلی آن‌ها (`user_stats`) نگهداری می‌کند. استفاده از Materialized View به جای یک کوئری پیچیده در هر بار درخواست، باعث افزایش چشمگیر سرعت در نمایش لیدربورد اصلی می‌شود. این نما باید به صورت دوره‌ای (مثلاً با یک CRON job) رفرش شود.

| نام ستون | نوع داده | توضیحات |
| :--- | :--- | :--- |
| `user_id` | `bigint` | شناسه‌ی کاربر. |
| `username` | `character varying`| نام کاربری. |
| `total_points`| `bigint` | مجموع امتیازات. |
| `games_won` | `integer` | تعداد بازی‌های برده. |
| `games_played`| `integer` | تعداد بازی‌های انجام شده. |
| `accuracy_rate`| `numeric` | درصد پاسخ‌های صحیح. |

---

## 18. توابع و تریگرها

سیستم شامل چندین تابع و تریگر PostgreSQL برای خودکارسازی به‌روزرسانی آمارها است:

*   **`fn_update_user_stats_after_round`**: پس از هر پاسخ کاربر در یک راند، آمار کلی او (تعداد پاسخ صحیح/غلط، امتیاز کل) را در جدول `user_stats` به‌روزرسانی می‌کند.
*   **`fn_update_user_category_stats`**: مشابه تابع بالا، اما آمار کاربر را به تفکیک دسته‌بندی در جدول `user_category_stats` به‌روزرسانی می‌کند.
*   **`fn_update_stats_after_game_complete`**: پس از اتمام یک بازی، آمار مربوط به برد و باخت، تعداد بازی‌ها و استریک (بردهای متوالی) را برای برنده و بازنده در `user_stats` آپدیت می‌کند.
*   **`fn_insert_into_leaderboards`**: پس از اتمام یک بازی، امتیاز نهایی برنده را در جدول `leaderboards` برای رتبه‌بندی `alltime` درج می‌کند.

این خودکارسازی‌ها به حفظ یکپارچگی داده‌ها کمک کرده و بار محاسباتی را از روی اپلیکیشن برمی‌دارند.
